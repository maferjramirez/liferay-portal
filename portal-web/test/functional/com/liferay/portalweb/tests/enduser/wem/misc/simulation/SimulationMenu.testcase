@component-name = "portal-wcm"
definition {

	property ci.retries.disabled = "true";
	property portal.release = "true";
	property portal.upstream = "true";
	property testray.component.names = "Simulation";
	property testray.main.component.name = "Web Content Administration";

	static var randomSiteName = StringUtil.randomString(8);

	var siteURLKey = StringUtil.toLowerCase(${randomSiteName});

	setUp {
		task ("Set up virtual instance") {
			TestCase.setUpPortalInstance();
		}

		task ("Sign in") {
			User.firstLoginPG();
		}

		task ("Add a site") {
			HeadlessSite.addSite(siteName = ${randomSiteName});
		}
	}

	@description = "The user could navigate to page under simulation mode."
	@priority = 3
	@uitest
	test NavigateToPageInSimulationMode {
		var siteName = StringUtil.randomString(8);

		var siteURLKey = StringUtil.toLowerCase(${siteName});

		task ("Add an Asset Publisher to a widget page") {
			HeadlessSite.addSite(
				siteName = ${siteName},
				templateName = "Welcome",
				templateType = "Site Initializer");

			JSONLayout.addPublicLayout(
				groupName = ${siteName},
				layoutName = "Test Page Name");

			JSONLayout.addWidgetToPublicLayout(
				groupName = ${siteName},
				layoutName = "Test Page Name",
				widgetName = "Asset Publisher");
		}

		task ("Navigate to the widget page") {
			Navigator.gotoSitePage(
				pageName = "Test Page Name",
				siteName = ${siteName});
		}

		task ("Access to Mobile Device mode via simulation menu") {
			MobileDevice.previewPG(deviceType = "smartphone");
		}

		task ("View the Asset Publisher is shown") {
			Portlet.viewTitle(portletName = "Asset Publisher");
		}

		task ("Navigate to Home page via Navigation Menu") {
			Click(locator1 = "NavBar#TOGGLE_NAVIGATION");

			Click(
				key_pageName = "Home",
				locator1 = "Home#PAGE");

			Smoke.viewWelcomeContentPage();
		}
	}

	@priority = 3
	test PreviewCustomDefault {
		MobileDevice.previewPG(deviceType = "custom");
	}

	@priority = 3
	test PreviewCustomHeightWidth {
		MobileDevice.previewPG(
			deviceType = "custom",
			height = 500,
			width = 500);
	}

	@priority = 3
	test PreviewDesktop {
		MobileDevice.previewPG(deviceType = "desktop");
	}

	@priority = 3
	test PreviewSmartphone {
		MobileDevice.previewPG(deviceType = "smartphone");
	}

	@priority = 3
	test PreviewTablet {
		MobileDevice.previewPG(deviceType = "tablet");
	}

	@description = "This is a test for LPS-128810. View collection items on content page when select segment."
	@priority = 4
	test ViewCollectionItemsOnContentPageWhenSelectSegment {
		task ("Add a segment with a Regular Role field") {
			var roleId = JSONPermissionSetter.setRoleId(roleTitle = "Owner");

			JSONSegmentsentry.addSegment(
				fieldName = "Regular Role",
				groupName = ${randomSiteName},
				operator = "equals",
				segmentName = "New Segment",
				text = ${roleId});
		}

		task ("Add a web content without tag") {
			JSONWebcontent.addWebContent(
				content = "Web Content Content",
				groupName = ${randomSiteName},
				title = "Web Content Title 1");
		}

		task ("Add a web content with tag") {
			JSONWebcontent.addWebContent(
				assetTagNames = "tag name",
				content = "Web Content Content",
				groupName = ${randomSiteName},
				title = "Web Content Title 2");
		}

		task ("Add a dynamic collection for Web Content Article and Basic Web Content") {
			AssetListsAdmin.openAssetListsAdmin(siteURLKey = ${siteURLKey});

			AssetListsAdmin.addDynamicSelection(assetListTitle = "Dynamic Collection");

			AssetListsAdmin.configureItemTypeInDynamicCollection(
				itemSubtype = "Basic Web Content",
				itemType = "Web Content Article");
		}

		task ("Add a new personalized variation with new segment") {
			AssetListsAdmin.addPersonalizedVariation(segmentName = "New Segment");
		}

		task ("Select the Web Content Article item type and Basic Web Content item subtype") {
			AssetListsAdmin.configureItemTypeInDynamicCollection(
				itemSubtype = "Basic Web Content",
				itemType = "Web Content Article");
		}

		task ("Add a tag filter") {
			AssetListsAdmin.addTagsFilter(tagNameList = "tag name");
		}

		task ("View both web contents shown in collection items when select Anyone personalized variation") {
			AssetListsAdmin.viewContent(
				assetTitleList = "Web Content Title 1,Web Content Title 2",
				personalizedVariation = "Anyone");
		}

		task ("View only the web content with tag is shown in collection items when select New Segment personalized variation") {
			AssetListsAdmin.viewContent(
				assetTitle = "Web Content Title 2",
				assetType = "Web Content Article",
				personalizedVariation = "New Segment");

			AssetListsAdmin.viewNoContent(
				assetTitle = "Web Content Title 1",
				assetType = "Web Content Article",
				personalizedVariation = "New Segment");

			AssetListsAdmin.prioritizeVariation(variationTitle = "New Segment");
		}

		task ("Add a Collection Display fragment to content page") {
			JSONLayout.addPublicLayout(
				groupName = ${randomSiteName},
				layoutName = "Test Page Name",
				type = "content");

			ContentPagesNavigator.openEditContentPage(
				pageName = "Test Page Name",
				siteName = ${randomSiteName});

			PageEditor.addFragment(
				collectionName = "Content Display",
				fragmentName = "Collection Display");
		}

		task ("Select the dynamic collection in Collection Display") {
			PageEditor.editCollectionDisplay(
				assetListName = "Dynamic Collection",
				fragmentName = "Collection Display");
		}

		task ("Add a Heading fragment into Collection Display") {
			PageEditor.addFragmentToCollectionDisplay(
				collectionName = "Basic Components",
				entryTitle = "Web Content Title 2",
				fragmentName = "Heading");
		}

		task ("Map the Title field to editable field of Heading") {
			PageEditorMapping.mapEditableFieldToCollectionItems(
				field = "Title",
				fragmentName = "Heading",
				id = "element-text");

			PageEditor.publish();
		}

		task ("View both web contents shown in simulation modal by default") {
			ContentPagesNavigator.openViewContentPage(
				pageName = "Test Page Name",
				siteName = ${randomSiteName});

			MobileDevice.previewPG();

			var n = 1;

			for (var title : list "Web Content Title 2,Web Content Title 1") {
				ContentPages.viewFragmentTextInCollectionDisplay(
					row = ${n},
					text = ${title});

				var n = ${n} + 1;
			}

			SelectFrameTop();
		}

		task ("Select the segment on Simulation panel") {
			Check.checkNotVisible(
				checkboxName = "New Segment",
				locator1 = "Checkbox#ANY_CHECKBOX");
		}

		task ("View only the web content with tag shown in simulation modal when select segment") {
			SelectFrame.selectFrameNoLoading(locator1 = "ControlMenuPreviewPanel#PREVIEW_DEVICE_GENERAL_IFRAME");

			ContentPages.viewFragmentTextInCollectionDisplay(text = "Web Content Title 2");

			AssertElementNotPresent(
				column = 1,
				locator1 = "Fragment#FRAGMENT_TEXT_IN_COLLECTION_DISPLAY",
				row = 2);
		}
	}

	@description = "This is a test for LPS-187159. View info alert message under Simulation panel in content page."
	@priority = 4
	test ViewInfoMessageWhenPreviewContentPage {
		property custom.properties = "feature.flag.LPS-186558=true";

		task ("Given a site administrator has a content page with experience based on new segment") {
			JSONSegmentsentry.addSegment(
				fieldName = "Email Address",
				groupName = ${randomSiteName},
				operator = "contains",
				segmentName = "Email Address Segment",
				text = "liferay");

			JSONLayout.addPublicLayout(
				groupName = ${randomSiteName},
				layoutName = "Test Page Name",
				type = "content");

			ContentPagesNavigator.openEditContentPage(
				pageName = "Test Page Name",
				siteName = ${randomSiteName});

			PageEditor.addExperience(
				experienceName = "New Experience",
				segmentName = "Email Address Segment");

			PageEditor.addFragment(
				collectionName = "Basic Components",
				fragmentName = "Button");

			PageEditor.publish();
		}

		task ("When the site administrator previews the content page by Anyone segment") {
			ContentPagesNavigator.openViewContentPage(
				pageName = "Test Page Name",
				siteName = ${randomSiteName});

			Click.waitForMenuToggleJSClick(locator1 = "ControlMenu#SIMULATION");
		}

		task ("Then the site administrator sees the info message shown on preview window") {
			Alert.viewInfoMessageSpecific(infoMessage = "Showing content for the segment \"Anyone\".");
		}

		task ("When the site administrator previews the content page by new segment") {
			MobileDevice.previewBy(segment = "Email Address Segment");
		}

		task ("Then the site administrator sees the info message shown on preview window") {
			Alert.viewInfoMessageSpecific(infoMessage = "Showing content for the segment \"Email Address Segment\".");
		}

		task ("When the site administrator previews the content page by Default experience") {
			MobileDevice.previewBy(previewBy = "Experiences");
		}

		task ("Then the site administrator sees the info message shown on preview window") {
			Alert.viewInfoMessageSpecific(infoMessage = "Showing content for the experience \"Default\".");
		}

		task ("When the site administrator previews the content page by new experience") {
			MobileDevice.previewBy(experience = "New Experience");
		}

		task ("Then the site administrator sees the info message shown on preview window") {
			Alert.viewInfoMessageSpecific(infoMessage = "Showing content for the experience \"New Experience\".");
		}
	}

	@description = "This is a test for LPS-187159. View info alert message under Simulation panel in widget page."
	@priority = 4
	test ViewInfoMessageWhenPreviewWidgetPage {
		property custom.properties = "feature.flag.LPS-186558=true";

		task ("Given a site administrator has a widget page") {
			JSONSegmentsentry.addSegment(
				fieldName = "Email Address",
				groupName = ${randomSiteName},
				operator = "contains",
				segmentName = "Email Address Segment",
				text = "liferay");

			JSONLayout.addPublicLayout(
				groupName = ${randomSiteName},
				layoutName = "Test Page Name");
		}

		task ("When the site administrator previews the widget page by Anyone segment") {
			Navigator.gotoSitePage(
				pageName = "Test Page Name",
				siteName = ${randomSiteName});

			Click.waitForMenuToggleJSClick(locator1 = "ControlMenu#SIMULATION");
		}

		task ("Then the site administrator sees the info message shown on preview window") {
			Alert.viewInfoMessageSpecific(infoMessage = "Showing content for the segment \"Anyone\".");
		}

		task ("When the site administrator previews the content page by new segment") {
			MobileDevice.previewBy(segment = "Email Address Segment");
		}

		task ("Then the site administrator sees the info message shown on preview window") {
			Alert.viewInfoMessageSpecific(infoMessage = "Showing content for the segment \"Email Address Segment\".");
		}
	}

}